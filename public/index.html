<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sewa Kereta Murah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Simple router visibility classes */
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased pb-20">

    <!-- === PUBLIC HEADER === -->
    <header id="public-header" class="sticky top-0 z-40 bg-white shadow-sm px-4 py-4 flex justify-between items-center">
        <div onclick="location.hash=''" class="cursor-pointer">
            <h1 class="text-xl font-bold text-blue-700 tracking-tight">SewaKereta<span class="text-blue-500">Murah</span></h1>
            <p class="text-xs text-gray-500">Pantas. Mudah. Berbaloi.</p>
        </div>
        <div class="flex gap-4">
            <!-- Hidden Admin Link (Visible if you know where to click or typed in URL) -->
            <a href="#login" class="text-gray-400 hover:text-blue-600"><i class="fas fa-user-lock"></i></a>
        </div>
    </header>

    <!-- === ADMIN HEADER === -->
    <header id="admin-header" class="hidden sticky top-0 z-40 bg-gray-900 text-white shadow-sm px-4 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">Admin Panel</h1>
        </div>
        <button onclick="logout()" class="text-sm bg-red-600 px-3 py-1 rounded">Logout</button>
    </header>

    <!-- ================= PAGES ================= -->

    <!-- 1. HOME PAGE (PUBLIC) -->
    <main id="home-page" class="page active max-w-md mx-auto px-4 py-6">
        <!-- Hero -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-400 rounded-2xl p-6 text-white mb-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-1">Promosi Merdeka!</h2>
            <p class="text-sm opacity-90 mb-3">Diskaun untuk tempahan 3 hari ke atas.</p>
        </div>

        <!-- Filter Chips -->
        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-2" id="filter-container">
            <button onclick="filterCars('Semua')" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-md transition-all">Semua</button>
            <button onclick="filterCars('Ekonomi')" class="filter-btn bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap hover:bg-gray-50 transition-all">Ekonomi</button>
            <button onclick="filterCars('Sedan')" class="filter-btn bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap hover:bg-gray-50 transition-all">Sedan</button>
            <button onclick="filterCars('MPV')" class="filter-btn bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap hover:bg-gray-50 transition-all">MPV</button>
            <button onclick="filterCars('SUV')" class="filter-btn bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap hover:bg-gray-50 transition-all">SUV</button>
        </div>

        <!-- Car List -->
        <div id="car-list" class="space-y-4">
            <div class="animate-pulse space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm h-64"></div>
            </div>
        </div>
    </main>

    <!-- 2. LOGIN PAGE -->
    <main id="login-page" class="page max-w-sm mx-auto px-4 py-20">
        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Admin Login</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-pass" class="w-full mt-1 p-3 border rounded-xl focus:ring-blue-500" placeholder="Masukkan password (admin123)">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Masuk</button>
            </form>
            <p id="login-error" class="text-red-500 text-center text-sm mt-3 hidden">Password salah.</p>
        </div>
    </main>

    <!-- 3. ADMIN DASHBOARD -->
    <main id="admin-page" class="page max-w-4xl mx-auto px-4 py-6">
        
        <!-- Admin Tabs -->
        <div class="flex gap-4 mb-6 border-b pb-2">
            <button onclick="switchAdminTab('orders')" id="tab-orders" class="font-bold text-blue-600 border-b-2 border-blue-600 pb-2">Tempahan</button>
            <button onclick="switchAdminTab('cars')" id="tab-cars" class="font-bold text-gray-500 pb-2">Inventori Kereta</button>
        </div>

        <!-- Orders Section -->
        <div id="admin-orders-view">
            <h3 class="text-lg font-bold mb-4">Senarai Tempahan Terkini</h3>
            <div class="overflow-x-auto">
                <table class="w-full bg-white shadow-sm rounded-lg overflow-hidden text-sm">
                    <thead class="bg-gray-100 text-left">
                        <tr>
                            <th class="p-3">ID</th>
                            <th class="p-3">Kereta</th>
                            <th class="p-3">Tarikh</th>
                            <th class="p-3">Harga</th>
                            <th class="p-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="admin-orders-list">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cars Section -->
        <div id="admin-cars-view" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Senarai Kereta</h3>
                <button onclick="openCarModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm shadow hover:bg-green-700">+ Tambah Kereta</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="admin-car-list">
                <!-- Filled by JS -->
            </div>
        </div>
    </main>

    <!-- ================= MODALS ================= -->

    <!-- Booking Modal (Public) -->
    <div id="booking-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Butiran Tempahan</h3>
                <button onclick="closeModal('booking-modal')" class="text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex items-center gap-4 mb-6 bg-blue-50 p-3 rounded-xl">
                <img id="modal-car-image" src="" class="w-20 h-14 object-cover rounded-lg">
                <div>
                    <h4 id="modal-car-name" class="font-bold text-sm"></h4>
                    <p id="modal-car-price" class="text-blue-600 text-xs font-semibold"></p>
                </div>
            </div>

            <form id="booking-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Mula</label>
                        <input type="date" id="start-date" class="w-full bg-gray-50 border rounded-xl px-3 py-2 text-sm" required>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Tamat</label>
                        <input type="date" id="end-date" class="w-full bg-gray-50 border rounded-xl px-3 py-2 text-sm" required>
                    </div>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-blue-700 border-t pt-4">
                    <span>Jumlah</span>
                    <span id="total-price-display">RM 0.00</span>
                </div>
                <button type="submit" id="btn-submit-booking" class="w-full bg-green-500 text-white font-bold py-3.5 rounded-xl shadow-lg flex justify-center items-center gap-2">
                    <i class="fab fa-whatsapp text-xl"></i> Hantar Booking
                </button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Car Modal (Admin) -->
    <div id="admin-car-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 m-4 shadow-2xl">
            <h3 class="text-lg font-bold mb-4" id="car-modal-title">Tambah Kereta</h3>
            <form id="admin-car-form" class="space-y-3">
                <input type="hidden" id="edit-car-id">
                <input type="text" id="edit-name" placeholder="Nama Kereta (cth: Perodua Myvi)" class="w-full border p-2 rounded" required>
                <select id="edit-category" class="w-full border p-2 rounded">
                    <option value="Ekonomi">Ekonomi</option>
                    <option value="Sedan">Sedan</option>
                    <option value="MPV">MPV</option>
                    <option value="SUV">SUV</option>
                    <option value="Compact">Compact</option>
                </select>
                <input type="url" id="edit-image" placeholder="Image URL" class="w-full border p-2 rounded" required>
                <input type="number" step="0.01" id="edit-price" placeholder="Harga Sehari (RM)" class="w-full border p-2 rounded" required>
                <select id="edit-trans" class="w-full border p-2 rounded">
                    <option value="Auto">Auto</option>
                    <option value="Manual">Manual</option>
                </select>
                <select id="edit-status" class="w-full border p-2 rounded">
                    <option value="Available">Available</option>
                    <option value="Booked">Booked</option>
                </select>
                
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('admin-car-modal')" class="w-1/2 bg-gray-200 py-2 rounded">Batal</button>
                    <button type="submit" id="btn-save-car" class="w-1/2 bg-blue-600 text-white py-2 rounded">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const WHATSAPP_PHONE = "60123456789"; 
        const API_CARS = "/api/cars";
        const API_BOOKINGS = "/api/bookings";
        const API_ADMIN_LOGIN = "/api/login";
        const API_ADMIN_CARS = "/api/admin/cars";
        const API_ADMIN_BOOKINGS = "/api/admin/bookings";

        // --- STATE ---
        let allCars = [];
        let selectedCar = null;
        let adminToken = localStorage.getItem('adminToken');

        // --- ROUTING ---
        function handleRouting() {
            const hash = window.location.hash || '#home';
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('public-header').classList.remove('hidden');
            document.getElementById('admin-header').classList.add('hidden');

            if (hash === '#admin') {
                if (!adminToken) {
                    window.location.hash = '#login';
                    return;
                }
                document.getElementById('admin-page').classList.add('active');
                document.getElementById('public-header').classList.add('hidden');
                document.getElementById('admin-header').classList.remove('hidden');
                loadAdminData();
            } else if (hash === '#login') {
                if (adminToken) {
                    window.location.hash = '#admin';
                    return;
                }
                document.getElementById('login-page').classList.add('active');
            } else {
                document.getElementById('home-page').classList.add('active');
                fetchCars();
            }
        }

        window.addEventListener('hashchange', handleRouting);
        window.addEventListener('DOMContentLoaded', () => {
            // Set min dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').min = today;
            document.getElementById('end-date').min = today;
            handleRouting();
        });

        // --- PUBLIC: CARS ---
        async function fetchCars() {
            try {
                const res = await fetch(API_CARS);
                allCars = await res.json();
                renderCars(allCars);
            } catch (e) { console.error(e); }
        }

        function renderCars(cars) {
            const list = document.getElementById('car-list');
            list.innerHTML = '';
            cars.forEach(car => {
                const isAvail = car.status === 'Available';
                const el = document.createElement('div');
                el.className = "bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden";
                el.innerHTML = `
                    <div class="relative h-48">
                        <img src="${car.image_url}" class="w-full h-full object-cover">
                        ${!isAvail ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center"><span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">Disewa</span></div>' : ''}
                        <span class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded">${car.category}</span>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-800">${car.name}</h3>
                            <div class="text-right">
                                <span class="text-blue-600 font-bold">RM${car.price_per_day}</span><span class="text-xs">/hari</span>
                            </div>
                        </div>
                        <button onclick="openBookingModal(${car.id})" ${!isAvail ? 'disabled' : ''} class="w-full py-2 rounded-xl font-bold text-sm ${isAvail ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-400'}">
                            ${isAvail ? 'Pilih Kereta' : 'Tidak Tersedia'}
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        window.filterCars = (cat) => {
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => {
                b.className = b.textContent.trim() === cat 
                    ? "filter-btn bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium shadow-md"
                    : "filter-btn bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-sm hover:bg-gray-50";
            });
            const filtered = cat === 'Semua' ? allCars : allCars.filter(c => c.category === cat);
            renderCars(filtered);
        };

        // --- PUBLIC: BOOKING ---
        window.openBookingModal = (id) => {
            selectedCar = allCars.find(c => c.id === id);
            document.getElementById('modal-car-image').src = selectedCar.image_url;
            document.getElementById('modal-car-name').innerText = selectedCar.name;
            document.getElementById('modal-car-price').innerText = `RM${selectedCar.price_per_day} / hari`;
            document.getElementById('booking-modal').classList.remove('hidden');
        };

        const calcTotal = () => {
            const s = document.getElementById('start-date').value;
            const e = document.getElementById('end-date').value;
            if(!s || !e) return 0;
            const diff = Math.ceil((new Date(e) - new Date(s)) / (86400000));
            return diff > 0 ? diff : 0;
        };

        ['start-date', 'end-date'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                const days = calcTotal();
                const total = days * (selectedCar ? selectedCar.price_per_day : 0);
                document.getElementById('total-price-display').innerText = `RM ${total.toFixed(2)}`;
            });
        });

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-booking');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const days = calcTotal();
            const total = days * selectedCar.price_per_day;

            // 1. Save to DB
            try {
                const res = await fetch(API_BOOKINGS, {
                    method: 'POST',
                    body: JSON.stringify({
                        car_id: selectedCar.id,
                        car_name: selectedCar.name,
                        start_date: start,
                        end_date: end,
                        total_days: days,
                        total_price: total
                    })
                });
                const data = await res.json();
                
                // 2. Redirect to WA
                if(data.success) {
                    const msg = `Order ID: #${data.id}\nSalam, saya nak sewa: ${selectedCar.name}\nTarikh: ${start} hingga ${end} (${days} hari)\nTotal: RM${total.toFixed(2)}`;
                    window.location.href = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`;
                } else {
                    alert("Gagal memproses tempahan.");
                }
            } catch(err) {
                alert("Ralat sambungan.");
            } finally {
                btn.innerHTML = originalText;
            }
        });

        // --- ADMIN: AUTH ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const pass = document.getElementById('admin-pass').value;
            const res = await fetch(API_ADMIN_LOGIN, {
                method: 'POST',
                body: JSON.stringify({ password: pass })
            });
            const data = await res.json();
            if(data.success) {
                localStorage.setItem('adminToken', data.token);
                adminToken = data.token;
                window.location.hash = '#admin';
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logout = () => {
            localStorage.removeItem('adminToken');
            adminToken = null;
            window.location.hash = '#login';
        };

        // --- ADMIN: DASHBOARD ---
        function switchAdminTab(tab) {
            document.getElementById('admin-orders-view').className = tab === 'orders' ? 'block' : 'hidden';
            document.getElementById('admin-cars-view').className = tab === 'cars' ? 'block' : 'hidden';
            
            document.getElementById('tab-orders').className = tab === 'orders' 
                ? "font-bold text-blue-600 border-b-2 border-blue-600 pb-2" 
                : "font-bold text-gray-500 pb-2";
            document.getElementById('tab-cars').className = tab === 'cars' 
                ? "font-bold text-blue-600 border-b-2 border-blue-600 pb-2" 
                : "font-bold text-gray-500 pb-2";
        }

        async function loadAdminData() {
            const headers = { 'Authorization': `Bearer ${adminToken}` };
            
            // Load Orders
            try {
                const resOrders = await fetch(API_ADMIN_BOOKINGS, { headers });
                const orders = await resOrders.json();
                const orderHtml = orders.map(o => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-gray-500">#${o.id}</td>
                        <td class="p-3 font-bold">${o.car_name}</td>
                        <td class="p-3 text-xs">${o.start_date}<br>hingga ${o.end_date}</td>
                        <td class="p-3 text-blue-600 font-bold">RM${o.total_price}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">${o.status}</span></td>
                    </tr>
                `).join('');
                document.getElementById('admin-orders-list').innerHTML = orderHtml || '<tr><td colspan="5" class="p-4 text-center">Tiada tempahan.</td></tr>';
            } catch(e) { console.error("Orders load failed", e); }

            // Load Cars (Admin View)
            try {
                const resCars = await fetch(API_CARS);
                const cars = await resCars.json();
                const carHtml = cars.map(c => `
                    <div class="bg-white border rounded-lg p-3 shadow-sm relative">
                        <img src="${c.image_url}" class="w-full h-32 object-cover rounded mb-2">
                        <h4 class="font-bold text-sm">${c.name}</h4>
                        <p class="text-xs text-gray-500 mb-2">${c.category} - ${c.transmission}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-600 font-bold text-sm">RM${c.price_per_day}</span>
                            <div class="flex gap-2">
                                <button onclick="editCar(${c.id})" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteCar(${c.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <span class="absolute top-2 right-2 text-[10px] px-2 py-1 rounded ${c.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${c.status}</span>
                    </div>
                `).join('');
                document.getElementById('admin-car-list').innerHTML = carHtml;
            } catch(e) { console.error("Cars load failed", e); }
        }

        // --- ADMIN: CAR CRUD ---
        window.openCarModal = (reset = true) => {
            if(reset) {
                document.getElementById('admin-car-form').reset();
                document.getElementById('edit-car-id').value = '';
                document.getElementById('car-modal-title').innerText = "Tambah Kereta";
            }
            document.getElementById('admin-car-modal').classList.remove('hidden');
        };

        window.editCar = (id) => {
            const c = allCars.find(x => x.id === id);
            document.getElementById('edit-car-id').value = c.id;
            document.getElementById('edit-name').value = c.name;
            document.getElementById('edit-category').value = c.category;
            document.getElementById('edit-image').value = c.image_url;
            document.getElementById('edit-price').value = c.price_per_day;
            document.getElementById('edit-trans').value = c.transmission;
            document.getElementById('edit-status').value = c.status;
            document.getElementById('car-modal-title').innerText = "Edit Kereta";
            openCarModal(false);
        };

        window.deleteCar = async (id) => {
            if(!confirm("Anda pasti mahu buang kereta ini?")) return;
            await fetch(`${API_ADMIN_CARS}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            loadAdminData(); // Refresh
        };

        document.getElementById('admin-car-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-car');
            const originalText = btn.innerText;
            btn.innerText = "Simpan...";
            btn.disabled = true;

            try {
                const id = document.getElementById('edit-car-id').value;
                const data = {
                    name: document.getElementById('edit-name').value,
                    category: document.getElementById('edit-category').value,
                    image_url: document.getElementById('edit-image').value,
                    price_per_day: parseFloat(document.getElementById('edit-price').value),
                    transmission: document.getElementById('edit-trans').value,
                    status: document.getElementById('edit-status').value
                };

                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_ADMIN_CARS}/${id}` : API_ADMIN_CARS;

                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error || "Ralat pelayan");
                }
                
                closeModal('admin-car-modal');
                loadAdminData();
            } catch (err) {
                alert("Gagal simpan: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // Common Utils
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

    </script>
</body>
</html>